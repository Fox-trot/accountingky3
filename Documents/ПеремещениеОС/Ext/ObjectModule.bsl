#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

// Процедура - обработчик события ОбработкаЗаполнения объекта.
//
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	ЗаполнениеОбъектовБП.ЗаполнитьДокумент(ЭтотОбъект, ДанныеЗаполнения);
КонецПроцедуры

// Процедура - обработчик события ОбработкаПроведения объекта.
//
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// Инициализация дополнительных свойств для проведения документа.
	БухгалтерскийУчетСервер.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства);
	
	// Инициализация данных документа.
	Документы.ПеремещениеОС.ИнициализироватьДанныеДокумента(Ссылка, ДополнительныеСвойства);
	
	// Подготовка наборов записей.
	БухгалтерскийУчетСервер.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);
	
	// Отражение в разделах учета. 	
	БухгалтерскийУчетСервер.ОтразитьМестонахождениеОС(ДополнительныеСвойства, Движения, Отказ);	
	БухгалтерскийУчетСервер.ОтразитьСобытияОС(ДополнительныеСвойства, Движения, Отказ); 
	БухгалтерскийУчетСервер.ОтразитьСоставОС(ДополнительныеСвойства, Движения, Отказ);

	// Запись наборов записей.
	БухгалтерскийУчетСервер.ЗаписатьНаборыЗаписей(ЭтотОбъект);
	
	ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц.Закрыть();
	
КонецПроцедуры // ОбработкаПроведения()

// Процедура - обработчик события ОбработкаУдаленияПроведения объекта.
//
Процедура ОбработкаУдаленияПроведения(Отказ)
	
	// Инициализация дополнительных свойств для проведения документа
	БухгалтерскийУчетСервер.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства);
	
	// Подготовка наборов записей
	БухгалтерскийУчетСервер.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);
	
	// Запись наборов записей
	БухгалтерскийУчетСервер.ЗаписатьНаборыЗаписей(ЭтотОбъект);
	
	ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц.Закрыть();
КонецПроцедуры // ОбработкаУдаленияПроведения()

// Процедура - обработчик события ОбработкаПроверкиЗаполнения объекта.
//
Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	Если МОЛОтправитель = МОЛПолучатель 
		И ПодразделениеОтправитель = ПодразделениеПолучатель Тогда
		ТекстСообщения = НСтр("ru = 'Указан одинаковый МОЛ и одинаковое подразделение!'");
		БухгалтерскийУчетСервер.СообщитьОбОшибке(
			Ссылка,   
			ТекстСообщения,
			,
			,
			"Объект.МОЛПолучатель",
			Отказ);
	КонецЕсли;
	
	Если ПолучитьФункциональнуюОпцию("ВестиУчетОСПоКомплектам") Тогда
		КонтрольКомплектов(Отказ);
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура КонтрольКомплектов(Отказ)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ПеремещениеОСОС.ОсновноеСредство КАК Справочник.ОсновныеСредства) КАК ОсновноеСредство,
		|	ПеремещениеОСОС.НомерСтроки КАК НомерСтроки
		|ПОМЕСТИТЬ ВременнаяТаблицаОС
		|ИЗ
		|	&ТаблицаОС КАК ПеремещениеОСОС
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВременнаяТаблицаОС.ОсновноеСредство КАК ОсновноеСредство
		|ПОМЕСТИТЬ ВременнаяТаблицаТабличнаяЧастьОС
		|ИЗ
		|	ВременнаяТаблицаОС КАК ВременнаяТаблицаОС
		|ГДЕ
		|	НЕ ВременнаяТаблицаОС.ОсновноеСредство.ЭтоКомплект
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СоставОССрезПоследних.ОсновноеСредство КАК ОсновноеСредство,
		|	СоставОССрезПоследних.ОсновноеСредствоВСоставеКомплекта КАК ОсновноеСредствоВСоставеКомплекта,
		|	ВременнаяТаблицаОС.НомерСтроки КАК НомерСтроки
		|ПОМЕСТИТЬ ВременнаяТаблицаОСТЧВходящиеВКомплекты
		|ИЗ
		|	РегистрСведений.СоставОС.СрезПоследних(
		|			&Период,
		|			ОсновноеСредствоВСоставеКомплекта В
		|					(ВЫБРАТЬ
		|						ВременнаяТаблицаТабличнаяЧастьОС.ОсновноеСредство КАК ОсновноеСредство
		|					ИЗ
		|						ВременнаяТаблицаТабличнаяЧастьОС КАК ВременнаяТаблицаТабличнаяЧастьОС)
		|				И НЕ Регистратор = &Ссылка) КАК СоставОССрезПоследних
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаОС КАК ВременнаяТаблицаОС
		|		ПО СоставОССрезПоследних.ОсновноеСредствоВСоставеКомплекта = ВременнаяТаблицаОС.ОсновноеСредство
		|ГДЕ
		|	(СоставОССрезПоследних.СостояниеВСоставеОС = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийКомплектацияОС.Комплектация)
		|					ИЛИ СоставОССрезПоследних.СостояниеВСоставеОС = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийКомплектацияОС.Добавление))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВременнаяТаблицаОСТЧВходящиеВКомплекты.ОсновноеСредство КАК ОсновноеСредство
		|ПОМЕСТИТЬ ВременнаяТаблицаПроверяемыеКомплекты
		|ИЗ
		|	ВременнаяТаблицаОСТЧВходящиеВКомплекты КАК ВременнаяТаблицаОСТЧВходящиеВКомплекты
		|
		|СГРУППИРОВАТЬ ПО
		|	ВременнаяТаблицаОСТЧВходящиеВКомплекты.ОсновноеСредство
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СоставОССрезПоследних.ОсновноеСредство КАК ОсновноеСредство,
		|	СоставОССрезПоследних.ОсновноеСредствоВСоставеКомплекта КАК ОсновноеСредствоВСоставеКомплекта
		|ПОМЕСТИТЬ ВременнаяТаблицаСоставКомплектов
		|ИЗ
		|	ВременнаяТаблицаПроверяемыеКомплекты КАК ВременнаяТаблицаПроверяемыеКомплекты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СоставОС.СрезПоследних(
		|				&Период,
		|				ОсновноеСредство В
		|						(ВЫБРАТЬ
		|							ВременнаяТаблицаПроверяемыеКомплекты.ОсновноеСредство КАК ОсновноеСредство
		|						ИЗ
		|							ВременнаяТаблицаПроверяемыеКомплекты КАК ВременнаяТаблицаПроверяемыеКомплекты)
		|					И НЕ Регистратор = &Ссылка) КАК СоставОССрезПоследних
		|		ПО ВременнаяТаблицаПроверяемыеКомплекты.ОсновноеСредство = СоставОССрезПоследних.ОсновноеСредство
		|ГДЕ
		|	(СоставОССрезПоследних.СостояниеВСоставеОС = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийКомплектацияОС.Комплектация)
		|					ИЛИ СоставОССрезПоследних.СостояниеВСоставеОС = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийКомплектацияОС.Добавление))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВременнаяТаблицаСоставКомплектов.ОсновноеСредство КАК ОсновноеСредство
		|ПОМЕСТИТЬ ВременнаяТаблицаИсключитьКомплектыДляПроверки
		|ИЗ
		|	ВременнаяТаблицаСоставКомплектов КАК ВременнаяТаблицаСоставКомплектов
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаОСТЧВходящиеВКомплекты КАК ВременнаяТаблицаОСТЧВходящиеВКомплекты
		|		ПО ВременнаяТаблицаСоставКомплектов.ОсновноеСредство = ВременнаяТаблицаОСТЧВходящиеВКомплекты.ОсновноеСредство
		|			И ВременнаяТаблицаСоставКомплектов.ОсновноеСредствоВСоставеКомплекта = ВременнаяТаблицаОСТЧВходящиеВКомплекты.ОсновноеСредствоВСоставеКомплекта
		|ГДЕ
		|	ВременнаяТаблицаОСТЧВходящиеВКомплекты.ОсновноеСредствоВСоставеКомплекта ЕСТЬ NULL
		|
		|СГРУППИРОВАТЬ ПО
		|	ВременнаяТаблицаСоставКомплектов.ОсновноеСредство
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВременнаяТаблицаОСТЧВходящиеВКомплекты.ОсновноеСредство КАК ОсновноеСредство,
		|	ВременнаяТаблицаОСТЧВходящиеВКомплекты.ОсновноеСредствоВСоставеКомплекта КАК ОсновноеСредствоВСоставеКомплекта,
		|	ВременнаяТаблицаОСТЧВходящиеВКомплекты.НомерСтроки КАК НомерСтроки
		|ИЗ
		|	ВременнаяТаблицаОСТЧВходящиеВКомплекты КАК ВременнаяТаблицаОСТЧВходящиеВКомплекты
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаИсключитьКомплектыДляПроверки КАК ВременнаяТаблицаИсключитьКомплектыДляПроверки
		|		ПО ВременнаяТаблицаОСТЧВходящиеВКомплекты.ОсновноеСредство = ВременнаяТаблицаИсключитьКомплектыДляПроверки.ОсновноеСредство
		|ГДЕ
		|	ВременнаяТаблицаИсключитьКомплектыДляПроверки.ОсновноеСредство ЕСТЬ NULL";
	
	Запрос.Параметры.Вставить("Период", 	Дата);	
	Запрос.Параметры.Вставить("Ссылка", 	Ссылка);
	Запрос.УстановитьПараметр("ТаблицаОС", 	ОС.Выгрузить());
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			ТекстСообщения = СтрШаблон(НСтр("ru = 'Перемещаются все элементы комплекта ""%1"". Добавьте этот комплект в табличную часть, а основное средство ""%2"" удалите из табличной части.'"), 
							ВыборкаДетальныеЗаписи.ОсновноеСредство, ВыборкаДетальныеЗаписи.ОсновноеСредствоВСоставеКомплекта);
			БухгалтерскийУчетСервер.СообщитьОбОшибке(
				ЭтотОбъект,
				ТекстСообщения,
				"ОС",
				ВыборкаДетальныеЗаписи.НомерСтроки,
				"ОсновноеСредство",
				Отказ);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
